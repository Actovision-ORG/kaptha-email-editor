<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kaptha Email Editor v2.0 - Wrapper Test</title>
  <link rel="stylesheet" href="https://code.kaptha.dev/core/builder.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    #controls {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      z-index: 1000;
    }
    #controls h1 {
      font-size: 18px;
      font-weight: 600;
      margin-right: auto;
      color: #111827;
    }
    #controls button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    #controls button:hover {
      background: #2563eb;
    }
    #controls button:active {
      background: #1d4ed8;
    }
    #controls select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    #root {
      margin-top: 60px;
      height: calc(100vh - 60px);
    }
    #log {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1f2937;
      color: #f3f4f6;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid #374151;
      z-index: 1000;
    }
    #log div {
      margin-bottom: 4px;
      padding: 4px 0;
      border-bottom: 1px solid #374151;
    }
    #log .timestamp {
      color: #9ca3af;
      margin-right: 8px;
    }
    #log .success {
      color: #34d399;
    }
    #log .error {
      color: #f87171;
    }
  </style>
</head>
<body>
  <div id="controls">
    <h1>Kaptha Email Editor v2.0 - Wrapper Test</h1>
    <select id="apiKeySelect">
      <option value="kpt_dev_ws001_demo12345678">Dev (Unrestricted)</option>
      <option value="kpt_free_ws002_a1b2c3d4e5f6">Free (localhost only)</option>
      <option value="kpt_free_ws003_x1y2z3a4b5c6">Free (demo domains)</option>
      <option value="kpt_pro_ws004_h8i9j0k1l2m3">Pro (Acme Corp)</option>
    </select>
    <button onclick="handleSave()">üíæ Save Design</button>
    <button onclick="handleExportHtml()">üì§ Export HTML</button>
    <button onclick="handleExportMjml()">üìÑ Export MJML</button>
    <button onclick="handleLoadTemplate()">üìù Load Template</button>
    <button onclick="handleDestroy()">üóëÔ∏è Destroy</button>
  </div>

  <div id="root"></div>

  <div id="log"></div>

  <!-- Load React first -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Load Kaptha Email Editor Core (212KB, 57KB gzipped) -->
  <script src="https://code.kaptha.dev/core/builder.js"></script>

  <script>
    // Logging utility
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span><span class="${type}">${message}</span>`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    let editorInstance = null;

    // Initialize editor
    function initEditor() {
      const apiKey = document.getElementById('apiKeySelect').value;
      
      log(`Initializing editor with API key: ${apiKey}`, 'info');

      try {
        editorInstance = kapthaEmailEditor.init({
          id: 'root',
          apiKey: apiKey,
          minHeight: 'calc(100vh - 260px)',
          onReady: () => {
            log('‚úÖ Editor ready!', 'success');
          },
          onDesignChange: (design) => {
            log(`üé® Design changed (${design.components?.length || 0} components)`, 'info');
          }
        });

        log('‚úÖ Editor initialized successfully', 'success');
      } catch (err) {
        log(`‚ùå Failed to initialize: ${err.message}`, 'error');
        console.error(err);
      }
    }

    // Save design
    function handleSave() {
      if (!editorInstance) {
        log('‚ùå Editor not initialized', 'error');
        return;
      }

      try {
        const design = editorInstance.saveDesign();
        log(`üíæ Design saved (${design.components?.length || 0} components)`, 'success');
        console.log('Saved design:', design);
      } catch (err) {
        log(`‚ùå Save failed: ${err.message}`, 'error');
      }
    }

    // Export HTML
    async function handleExportHtml() {
      if (!editorInstance) {
        log('‚ùå Editor not initialized', 'error');
        return;
      }

      try {
        log('üì§ Exporting HTML...', 'info');
        const { html, mjml } = await editorInstance.exportHtml();
        log(`‚úÖ HTML exported (${html.length} chars, ${mjml.length} chars MJML)`, 'success');
        console.log('Exported HTML:', html);
        console.log('Exported MJML:', mjml);
        
        // Download HTML
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'email.html';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        log(`‚ùå Export failed: ${err.message}`, 'error');
      }
    }

    // Export MJML
    function handleExportMjml() {
      if (!editorInstance) {
        log('‚ùå Editor not initialized', 'error');
        return;
      }

      try {
        const mjml = editorInstance.exportMjml();
        log(`‚úÖ MJML exported (${mjml.length} chars)`, 'success');
        console.log('Exported MJML:', mjml);
        
        // Download MJML
        const blob = new Blob([mjml], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'email.mjml';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        log(`‚ùå Export failed: ${err.message}`, 'error');
      }
    }

    // Load template
    function handleLoadTemplate() {
      if (!editorInstance) {
        log('‚ùå Editor not initialized', 'error');
        return;
      }

      const template = {
        components: [
          {
            type: 'text',
            props: {
              content: '<h1>Hello from v2.0!</h1>',
              fontSize: '32px',
              color: '#3b82f6',
              align: 'center',
              padding: '40px 20px'
            }
          },
          {
            type: 'text',
            props: {
              content: '<p>This template was loaded using the new framework-agnostic API.</p>',
              fontSize: '16px',
              color: '#6b7280',
              align: 'center',
              padding: '0px 20px 40px'
            }
          },
          {
            type: 'button',
            props: {
              text: 'Learn More',
              url: 'https://kaptha.dev',
              backgroundColor: '#3b82f6',
              color: '#ffffff',
              borderRadius: '8px',
              padding: '12px 32px',
              align: 'center'
            }
          }
        ]
      };

      try {
        editorInstance.loadDesign(template);
        log('‚úÖ Template loaded successfully', 'success');
      } catch (err) {
        log(`‚ùå Load failed: ${err.message}`, 'error');
      }
    }

    // Destroy editor
    function handleDestroy() {
      if (!editorInstance) {
        log('‚ùå Editor not initialized', 'error');
        return;
      }

      try {
        editorInstance.destroy();
        editorInstance = null;
        log('‚úÖ Editor destroyed', 'success');
      } catch (err) {
        log(`‚ùå Destroy failed: ${err.message}`, 'error');
      }
    }

    // Handle API key changes
    document.getElementById('apiKeySelect').addEventListener('change', () => {
      if (editorInstance) {
        log('üîÑ Reinitializing with new API key...', 'info');
        handleDestroy();
      }
      initEditor();
    });

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      log('üöÄ Starting Kaptha Email Editor v2.0 Test', 'info');
      
      // Wait for CDN script to load
      if (typeof kapthaEmailEditor !== 'undefined') {
        initEditor();
      } else {
        // Poll for script load
        const checkScript = setInterval(() => {
          if (typeof kapthaEmailEditor !== 'undefined') {
            clearInterval(checkScript);
            initEditor();
          }
        }, 100);
      }
    });
  </script>
</body>
</html>
